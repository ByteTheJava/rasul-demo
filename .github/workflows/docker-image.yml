name: Delete Docker Image CI2

on:
  workflow_dispatch:
  
env:
  PROJECT_ID: hms-dev-381208
  CONTAINER_IMAGE_REPO: demo
  IMAGE_NAME: eu.gcr.io/hms-dev-381208/demo

jobs:
   build:
    name: Delete Docker Image
    runs-on: ubuntu-latest
    steps:
     - id: "gcloud_auth"
       name: "Authenticate to Google Cloud"
       uses: google-github-actions/auth@v0.4.4
       with:
          credentials_json: ${{ secrets.GCP_SA_KEY_DEV }}

     - name: Set up Cloud SDK
       uses: google-github-actions/setup-gcloud@v0.2.1
        
     - name: 'Cleanup untagged images in nonprod'
       run: gcloud container images list-tags  eu.gcr.io/${{env.PROJECT_ID}}/${{env.CONTAINER_IMAGE_REPO}}
            --filter='-tags:*'
            --format="get(digest)" 
            --limit=1 > tags && while read p; do gcloud container images delete "eu.gcr.io/${{env.PROJECT_ID}}/${{env.CONTAINER_IMAGE_REPO}}@$p" 
            --quiet; done < tags
 
