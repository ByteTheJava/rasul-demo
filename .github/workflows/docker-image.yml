name: Delete Docker Image CI

on:
  push:
    branches: [ "dev" ]

jobs:
   build:
    name: Delete Docker Image
    runs-on: ubuntu-latest
    steps:
     - name: 'Authenticate to Gcloud'
       uses: google-github-actions/setup-gcloud@master
       with:
              project_id: hms-dev-381208
              service_account_email: hms-dev-cicd@hms-dev-381208.iam.gserviceaccount.com
              service_account_key: ${{ secrets.GCP_SA_KEY_DEV }}
              export_default_credentials: true
     - name: 'Cleanup untagged images in nonprod'
       run: gcloud container images list-tags eu.gcr.io/hms-dev-381208/demo --filter='-tags:*' --format="get(digest)" --limit=10 > tags && while read p; do gcloud container images delete "eu.gcr.io/hms-dev-381208/demo@$p" --quiet; done < tags
 
